#!/bin/bash

# Ensure we are running on a clean environment.
[ -v HOME ] && exec -c "$0" "$@"

# Mark variables which are modified or created for export.
set -a

# Exit on error
set -e

# Load dotenv file
if [ -f "$1" ]; then source "$1"; __out="$1.php"
elif [ "$1" == '-' ]; then source /dev/stdin; __out=/dev/stdout
elif [ -f ".env" ]; then source ".env"; __out=".env.php"
else echo "Missing .env" >> /dev/stderr; exit 1;
fi;

# Output override
if [ "$2" == '-' ]; then __out=/dev/stdout
elif [ ! -z "$2" ]; then __out="$2"
fi

# Dump current env as PHP
printf '<?php $_SERVER = array_merge(' > $__out
/usr/bin/env php -r '
	$ignore = array("PWD", "SHLVL", "_", "__out");
	$env = array_diff_key(getenv(), array_flip($ignore));
	var_export($env);
' >> $__out
printf ', $_SERVER);' >> $__out
